include compiler.tup

# built-in objects (obj-y)
: foreach $(obj-y) <| *linux <|
: $(obj-y) |> !ld_linux |> built-in.o

# modules (obj-m)
CFLAGS += -DMODULE
modpost = $(LINUX_ROOT)/scripts/mod/modpost
: foreach $(obj-m) <| *linux <| {modules}
: foreach {modules} | $(modpost) |> $(modpost) %f |> %B.mod.c {mod-c}
: foreach {mod-c} |> !cc_linux |>

!ld_module = foreach | %B.mod.o $(LD) |> ^ LD [M] %o^ $(LD) -m elf_i386 -r -o %o %f %B.mod.o |> %B.ko
: {modules} |> !ld_module |> %B.ko
